<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Kos baik.com - Sistem Laporan Harian</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --primary: #3498db;
      --primary-dark: #2980b9;
      --secondary: #2ecc71;
      --secondary-dark: #27ae60;
      --danger: #e74c3c;
      --danger-dark: #c0392b;
      --warning: #f39c12;
      --dark: #2c3e50;
      --light: #ecf0f1;
      --gray: #95a5a6;
      --border: #bdc3c7;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #3498db 0%, #8e44ad 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      padding: 10px;
      display: flex; /* Ensure body takes full height and centers content */
      justify-content: center;
      align-items: center;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      overflow: hidden;
      width: 100%; /* Ensure it fills parent */
    }

    /* Styles for the main application wrapper, hidden by default */
    .main-app-wrapper {
        display: none; /* Hidden by default, shown after login */
        width: 100%;
        max-width: 1200px; /* Match app-container max-width */
        height: 100%;
        margin: auto;
    }

    /* Login Screen Styles */
    .login-container {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        max-width: 400px;
        width: 90%;
        text-align: center;
    }

    .login-container h2 {
        color: var(--dark);
        margin-bottom: 25px;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .login-container .form-group {
        margin-bottom: 20px;
        text-align: left;
    }

    .login-container label {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .login-container input[type="password"],
    .login-container select {
        padding: 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        font-size: 16px;
    }

    .login-container button {
        width: 100%;
        padding: 15px;
        font-size: 18px;
        border-radius: 10px;
        background: var(--primary);
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .login-container button:hover {
        background: var(--primary-dark);
    }

    .login-error {
        color: var(--danger);
        font-size: 14px;
        margin-top: 15px;
        display: none; /* Hidden by default */
    }

    /* Header Styles */
    header {
      background: var(--dark);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      background: var(--primary);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
    }

    .logo-text span {
      color: var(--secondary);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 15px; /* Increased gap */
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      flex-shrink: 0;
    }

    .user-name-display { /* New style for displaying logged-in user's name */
        color: white;
        font-weight: 500;
        font-size: 15px;
    }

    .logout-btn { /* Style for the new logout button */
        background: var(--danger);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .logout-btn:hover {
        background: var(--danger-dark);
    }

    .user-select {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      outline: none;
      cursor: pointer;
      font-size: 14px;
      display: none; /* Hide this select in header after login implemented */
    }
    .user-select option {
      background: var(--dark);
      color: white;
    }

    /* Navigation */
    nav {
      background: var(--primary);
      padding: 0 15px;
      overflow-x: auto;
      white-space: nowrap;
    }

    .nav-tabs {
      display: flex;
      list-style: none;
    }

    .nav-tabs li {
      padding: 12px 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
      font-weight: 500;
      font-size: 14px;
      color: white;
    }

    .nav-tabs li.active {
      background: rgba(255, 255, 255, 0.2);
      border-bottom: 3px solid var(--secondary);
    }

    .nav-tabs li:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
    }

    .nav-tabs i {
      margin-right: 5px;
    }

    /* Main Content */
    .main-content {
      padding: 20px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      color: var(--dark);
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--light);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title i {
      color: var(--primary);
      font-size: 18px;
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 15px;
      position: relative; /* For error messages */
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    select, input, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }

    input.error, select.error, textarea.error {
      border-color: var(--danger);
      box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.2);
    }

    .error-message {
      color: var(--danger);
      font-size: 12px;
      margin-top: 5px;
      display: block;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--secondary);
      color: white;
    }

    .btn-success:hover {
      background: var(--secondary-dark);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: var(--danger-dark);
    }

    .btn-warning {
      background: var(--warning);
      color: white;
    }

    .btn-warning:hover {
      background: #e67e22;
    }

    /* Report History */
    .history-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        align-items: flex-end;
    }
    .history-filters .form-group {
        flex: 1;
        min-width: 150px;
        margin-bottom: 0;
    }
    .history-filters .form-group.half-width {
        flex-basis: calc(50% - 5px); /* For sort/order */
        min-width: 120px;
    }
    .history-filters .form-group.full-width {
        flex-basis: 100%;
        min-width: unset;
    }

    .history-filters .btn {
        flex-shrink: 0;
        align-self: flex-start; /* Align buttons with filters */
        margin-top: 22px; /* Adjust as needed for alignment */
    }

    .history-item {
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 12px;
      background: #f9fbfd;
      transition: all 0.3s;
      position: relative;
    }

    .history-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      border-color: var(--primary);
    }

    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .report-meta {
      display: flex;
      gap: 10px;
      color: var(--gray);
      font-size: 12px;
    }

    .report-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .report-actions {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.05);
      color: var(--dark);
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }

    .action-btn:hover {
      background: var(--primary);
      color: white;
    }

    .report-content {
      line-height: 1.6;
      font-size: 14px;
    }

    .empty-state {
      text-align: center;
      padding: 30px 15px;
      color: var(--gray);
    }

    .empty-state i {
      font-size: 40px;
      margin-bottom: 12px;
      color: #ddd;
    }

    .empty-state-small {
      text-align: center;
      padding: 20px 0;
      color: #95a5a6;
    }

    .empty-state-small i {
      font-size: 24px;
      margin-bottom: 10px;
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--secondary);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transition: opacity 0.3s ease-in-out, bottom 0.3s ease-in-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast-notification.show {
      opacity: 1;
      bottom: 30px;
    }

    /* Notification Item in Sidebar */
    .notification-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    /* Download PDF Section Specific Styles */
    .download-controls { /* Changed from print-controls */
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        align-items: flex-end;
    }
    .download-controls .form-group { /* Changed from print-controls */
        flex: 1;
        min-width: 150px;
        margin-bottom: 0; /* Override default form-group margin */
    }
    .download-controls .btn { /* Changed from print-controls */
        flex-shrink: 0;
    }
    .pdf-preview { /* Changed from print-preview */
        border: 1px solid var(--border);
        padding: 20px;
        border-radius: 10px;
        background-color: #fcfcfc;
        min-height: 200px;
        overflow-y: auto;
    }
    .pdf-preview h3 { /* Changed from print-preview */
        text-align: center;
        margin-bottom: 20px;
        color: var(--dark);
    }
    .pdf-report-item { /* Changed from print-report-item */
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px dashed #eee;
    }
    .pdf-report-item:last-child { /* Changed from print-report-item */
        border-bottom: none;
        margin-bottom: 0;
    }
    .pdf-report-item p { /* Changed from print-report-item */
        margin-bottom: 5px;
        font-size: 14px;
    }
    .pdf-report-item strong { /* Changed from print-report-item */
        color: var(--primary-dark);
    }

    /* Chart styles */
    .chart-container {
        position: relative;
        height: 300px; /* Fixed height for charts */
        margin-bottom: 20px;
    }

    /* Footer */
    footer {
      background: var(--dark);
      color: white;
      text-align: center;
      padding: 15px;
      font-size: 13px;
    }

    /* New styles for image upload */
    .image-upload-preview {
      margin-top: 10px;
      text-align: center;
    }
    .image-upload-preview img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      border: 1px solid var(--border);
      display: none; /* Hidden by default */
    }

    /* Responsive Design */
    @media (min-width: 768px) {
      .main-content {
        grid-template-columns: 1fr 300px;
      }
    }

    @media (max-width: 600px) {
      .nav-tabs li span {
        display: none;
      }

      .nav-tabs li i {
        margin-right: 0;
        font-size: 16px;
      }

      .history-controls {
        flex-direction: column;
      }

      .report-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .report-meta {
        flex-wrap: wrap;
      }

      .logo-text {
        font-size: 18px;
      }

      .user-info {
        font-size: 14px;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
      }

      .user-select {
        padding: 6px 10px;
        font-size: 13px;
      }

      .app-container {
        border-radius: 0;
        margin: 0;
        min-height: 100vh;
      }
      header {
        padding: 15px;
      }
      .main-content {
        padding: 15px;
      }
      .card {
        padding: 15px;
      }
      .download-controls, .history-filters { /* Changed from print-controls */
          flex-direction: column;
          align-items: stretch;
      }
      .download-controls .form-group, .history-filters .form-group { /* Changed from print-controls */
          width: 100%;
      }
      .history-filters .form-group.half-width {
          flex-basis: 100%; /* Full width on small screens */
      }
      .download-controls .btn, .history-filters .btn { /* Changed from print-controls */
          width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <h2><i class="fas fa-lock" style="color: var(--primary);"></i> Login KosBaik.com</h2>
    <div class="form-group">
      <label for="loginUsername"><i class="fas fa-user"></i> Nama Pengurus:</label>
      <select id="loginUsername" required>
        <option value="">Pilih Pengurus</option>
        <option>Happy</option>
        <option>Tomi</option>
        <option>Indra</option>
        <option>Afi</option>
        <option>Amanda</option>
        <option>Nurul</option>
      </select>
    </div>
    <div class="form-group">
      <label for="loginPassword"><i class="fas fa-key"></i> Password:</label>
      <input type="password" id="loginPassword" required placeholder="Masukkan password Anda">
    </div>
    <div class="login-error" id="loginError"></div>
    <button id="loginButton">Login</button>
  </div>

  <div class="main-app-wrapper" id="mainAppWrapper">
    <div class="app-container">
      <header>
        <div class="logo">
          <div class="logo-icon"><i class="fas fa-home"></i></div>
          <div class="logo-text">Kos <span>baik.com</span></div>
        </div>
        <div class="user-info">
          <div class="user-avatar" id="header-avatar">-</div>
          <div class="user-name-display" id="loggedInUserName"></div>
          <button id="logoutButton" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
          <select id="currentUser" class="user-select">
            <option value="">Pilih Pengurus</option>
            <option>Happy</option>
            <option>Tomi</option>
            <option>Indra</option>
            <option>Afi</option>
            <option>Amanda</option>
            <option>Nurul</option>
          </select>
        </div>
      </header>

      <nav>
        <ul class="nav-tabs">
          <li data-tab-target="#dashboard" class="active"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></li>
          <li data-tab-target="#lapor"><i class="fas fa-plus-circle"></i> <span>Buat Laporan</span></li>
          <li data-tab-target="#riwayat"><i class="fas fa-history"></i> <span>Riwayat Laporan</span></li>
          <li data-tab-target="#downloadPdfReportSection"><i class="fas fa-file-pdf"></i> <span>Download Laporan</span></li>
          <li data-tab-target="#pengaturan"><i class="fas fa-cog"></i> <span>Pengaturan</span></li>
        </ul>
      </nav>

      <div class="main-content">
        <div class="content-left">
          <section id="dashboard" class="content-section active">
            <div class="card">
              <h2 class="card-title"><i class="fas fa-info-circle"></i> Ringkasan Laporan Anda</h2>
              <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: space-around; text-align: center;">
                <div style="flex: 1; min-width: 120px; background: #e8f5e9; padding: 15px; border-radius: 8px; font-weight: bold; color: var(--dark);">
                  Total Laporan<br><span id="dashboard-total-reports" style="font-size: 2em; color: var(--secondary);">0</span>
                </div>
                <div style="flex: 1; min-width: 120px; background: #e3f2fd; padding: 15px; border-radius: 8px; font-weight: bold; color: var(--dark);">
                  Total Jam Kerja<br><span id="dashboard-total-hours" style="font-size: 2em; color: var(--primary);">0</span>
                </div>
                <div style="flex: 1; min-width: 120px; background: #ffe0b2; padding: 15px; border-radius: 8px; font-weight: bold; color: var(--dark);">
                  Terakhir Lapor<br><span id="dashboard-last-report" style="font-size: 1em; color: var(--warning);">Belum ada</span>
                </div>
              </div>
            </div>

            <div class="card">
              <h2 class="card-title"><i class="fas fa-chart-bar"></i> Statistik Laporan Bulanan</h2>
              <div class="chart-container">
                  <canvas id="monthlyReportsChart"></canvas>
              </div>
            </div>

            <div class="card">
              <h2 class="card-title"><i class="fas fa-clipboard-list"></i> Aktivitas Laporan Terbaru Anda</h2>
              <div id="recent-activity-container">
                <div class="empty-state">
                  <i class="fas fa-clipboard"></i>
                  <p>Belum ada laporan dari Anda.</p>
                </div>
              </div>
            </div>
          </section>

          <section id="lapor" class="content-section">
            <div class="card">
              <h2 class="card-title"><i class="fas fa-file-alt"></i> Buat Laporan Baru</h2>
              <form id="reportForm">
                <input type="hidden" id="reportIdToEdit">
                <div class="form-group">
                  <label for="tanggal"><i class="fas fa-calendar-alt"></i> Tanggal:</label>
                  <input type="date" id="tanggal" required>
                  <span class="error-message" id="tanggal-error"></span>
                </div>
                <div class="form-group">
                  <label for="nama"><i class="fas fa-user"></i> Nama Pengurus:</label>
                  <select id="nama" required disabled> <option value="">Pilih Pengurus</option>
                    <option>Happy</option>
                    <option>Tomi</option>
                    <option>Indra</option>
                    <option>Afi</option>
                    <option>Amanda</option>
                    <option>Nurul</option>
                  </select>
                  <span class="error-message" id="nama-error"></span>
                </div>
                <div class="form-group">
                  <label for="jamKerja"><i class="fas fa-hourglass-half"></i> Jam Kerja (Jam):</label>
                  <input type="number" id="jamKerja" min="1" max="24" required>
                  <span class="error-message" id="jamKerja-error"></span>
                </div>
                <div class="form-group">
                  <label for="keterangan"><i class="fas fa-comment-dots"></i> Keterangan / Uraian Kegiatan:</label>
                  <textarea id="keterangan" placeholder="Masukkan uraian kegiatan Anda hari ini..." required></textarea>
                  <span class="error-message" id="keterangan-error"></span>
                </div>
                <div class="form-group">
                  <label for="fotoLaporan"><i class="fas fa-camera"></i> Unggah Foto (Opsional):</label>
                  <input type="file" id="fotoLaporan" accept="image/*">
                  <span class="error-message" id="fotoLaporan-error"></span>
                  <div class="image-upload-preview">
                    <img id="imagePreview" src="#" alt="Image Preview">
                  </div>
                </div>
                <button type="submit" class="btn btn-primary" id="submitReportBtn"><i class="fas fa-paper-plane"></i> Kirim Laporan</button>
                <button type="button" class="btn btn-danger" id="cancelEditBtn" style="display: none;"><i class="fas fa-times-circle"></i> Batalkan</button>
              </form>
            </div>
          </section>

          <section id="riwayat" class="content-section">
            <div class="card">
              <h2 class="card-title"><i class="fas fa-history"></i> Riwayat Laporan Anda</h2>
              <div class="history-filters">
                  <div class="form-group">
                      <label for="historyStartDate"><i class="fas fa-calendar-day"></i> Dari Tanggal:</label>
                      <input type="date" id="historyStartDate">
                  </div>
                  <div class="form-group">
                      <label for="historyEndDate"><i class="fas fa-calendar-day"></i> Sampai Tanggal:</label>
                      <input type="date" id="historyEndDate">
                  </div>
                  <div class="form-group full-width">
                      <label for="searchKeyword"><i class="fas fa-search"></i> Cari Keterangan:</label>
                      <input type="text" id="searchKeyword" placeholder="Cari di uraian kegiatan...">
                  </div>
                  <div class="form-group half-width">
                      <label for="filterJamKerjaMin"><i class="fas fa-clock"></i> Jam Kerja Min:</label>
                      <input type="number" id="filterJamKerjaMin" min="0" max="24" placeholder="Min">
                  </div>
                  <div class="form-group half-width">
                      <label for="filterJamKerjaMax"><i class="fas fa-clock"></i> Jam Kerja Max:</label>
                      <input type="number" id="filterJamKerjaMax" min="0" max="24" placeholder="Max">
                  </div>
                  <div class="form-group half-width">
                      <label for="sortBy"><i class="fas fa-sort"></i> Urutkan Berdasarkan:</label>
                      <select id="sortBy">
                          <option value="timestamp">Tanggal Dibuat</option>
                          <option value="tanggal">Tanggal Laporan</option>
                          <option value="jamKerja">Jam Kerja</option>
                      </select>
                  </div>
                  <div class="form-group half-width">
                      <label for="sortOrder"><i class="fas fa-sort-amount-down"></i> Urutan:</label>
                      <select id="sortOrder">
                          <option value="desc">Terbaru/Terbesar</option>
                          <option value="asc">Terlama/Terkecil</option>
                      </select>
                  </div>
                  <button id="applyHistoryFilters" class="btn btn-success"><i class="fas fa-filter"></i> Terapkan Filter</button>
                  <button id="clearHistoryFilters" class="btn btn-warning"><i class="fas fa-sync-alt"></i> Reset</button>
                  <button id="exportReportsCSV" class="btn btn-primary"><i class="fas fa-file-csv"></i> Export CSV</button>
              </div>
              <div id="riwayat-laporan-container">
                <div class="empty-state">
                  <i class="fas fa-folder-open"></i>
                  <p>Silakan pilih pengurus di atas untuk melihat riwayat laporan Anda, atau belum ada laporan.</p>
                </div>
              </div>
               <div class="form-group" style="margin-top: 30px;">
                  <button id="deleteAllUserReportsBtn" class="btn btn-danger" style="width: 100%;"><i class="fas fa-trash-alt"></i> Hapus Semua Riwayat Laporan</button>
                  <p style="color: var(--danger); font-size: 12px; margin-top: 5px;">*Tindakan ini tidak dapat dibatalkan dan hanya menghapus laporan untuk pengurus yang sedang aktif!</p>
              </div>
            </div>
          </section>

          <section id="downloadPdfReportSection" class="content-section">
            <div class="card">
              <h2 class="card-title"><i class="fas fa-file-pdf"></i> Download Laporan Anda (PDF)</h2>
              <div class="download-controls">
                  <div class="form-group">
                      <label for="printStartDate"><i class="fas fa-calendar-day"></i> Dari Tanggal:</label>
                      <input type="date" id="printStartDate">
                  </div>
                  <div class="form-group">
                      <label for="printEndDate"><i class="fas fa-calendar-day"></i> Sampai Tanggal:</label>
                      <input type="date" id="printEndDate">
                  </div>
                  <button id="generatePrint" class="btn btn-success"><i class="fas fa-eye"></i> Tampilkan Laporan</button>
                  <button id="downloadPdfButton" class="btn btn-primary" style="display: none;"><i class="fas fa-download"></i> Download PDF</button>
              </div>
              <div class="pdf-preview" id="pdf-preview-container">
                  <div class="empty-state">
                      <i class="fas fa-info-circle"></i>
                      <p>Pilih pengurus di header, lalu pilih rentang tanggal dan klik "Tampilkan Laporan" untuk melihat preview laporan.</p>
                  </div>
              </div>
            </div>
          </section>

          <section id="pengaturan" class="content-section">
              <div class="card">
                  <h2 class="card-title"><i class="fas fa-database"></i> Manajemen Data</h2>
                  <div class="form-group">
                      <label><i class="fas fa-download"></i> Backup Data Laporan Anda:</label>
                      <button id="backupUserDataBtn" class="btn btn-primary"><i class="fas fa-file-download"></i> Download Backup (JSON)</button>
                      <p style="color: var(--gray); font-size: 12px; margin-top: 5px;">*Hanya mengunduh laporan untuk pengurus yang sedang login.</p>
                  </div>
                  <div class="form-group">
                      <label><i class="fas fa-upload"></i> Restore Data Laporan Anda:</label>
                      <input type="file" id="restoreInput" accept=".json" class="form-control">
                      <button id="restoreUserDataBtn" class="btn btn-success" style="margin-top: 10px;"><i class="fas fa-file-upload"></i> Unggah & Restore</button>
                      <p style="color: var(--gray); font-size: 12px; margin-top: 5px;">*Hanya akan memulihkan data untuk pengurus yang sedang login.</p>
                  </div>
                  <div class="form-group" style="margin-top: 30px;">
                      <label><i class="fas fa-exclamation-triangle"></i> Hapus Semua Riwayat Laporan (Global):</label>
                      <button id="deleteAllReportsGlobalBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Hapus Semua Riwayat</button>
                      <p style="color: var(--danger); font-size: 12px; margin-top: 5px;">*Tindakan ini akan menghapus SEMUA laporan dari SEMUA pengurus dan tidak dapat dibatalkan!</p>
                  </div>
              </div>
          </section>

        </div>

        <div class="content-right">
          <div class="card">
            <h2 class="card-title"><i class="fas fa-bell"></i> Aktivitas Terbaru</h2>
            <div id="notifications-container">
              <div class="empty-state-small">
                <i class="fas fa-bell-slash"></i>
                <p>Belum ada aktivitas</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title"><i class="fas fa-hashtag"></i> KosBaik.com</h2>
            <p style="text-align: center; font-weight: bold; font-size: 18px; color: var(--primary); margin: 10px 0;">
              #ngekos bareng baik bareng
            </p>
          </div>
        </div>
      </div>

      <footer>
        &copy; 2025 Kos baik.com. All rights reserved.</footer>
    </div>
  </div>

  <div id="toast-notification" class="toast-notification"></div>

  <script>
    // --- Data Management ---
    // laporanRiwayat sekarang adalah objek yang menyimpan laporan per user
    let laporanRiwayat = JSON.parse(localStorage.getItem('laporanRiwayat')) || {};

    // users - predefined users with their passwords
    const users = {
        "Happy": "Happy123",
        "Tomi": "Tomi123",
        "Indra": "Indra123",
        "Afi": "Afi123",
        "Amanda": "Amanda123",
        "Nurul": "Nurul123"
    };

    let loggedInUser = localStorage.getItem('loggedInUser'); // Store logged in user

    let editingReportId = null;
    let monthlyReportsChartInstance = null; // Variable to hold the Chart.js instance

    // --- DOM Elements ---
    const loginContainer = document.getElementById('loginContainer');
    const loginUsernameSelect = document.getElementById('loginUsername');
    const loginPasswordInput = document.getElementById('loginPassword');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('loginError');

    const mainAppWrapper = document.getElementById('mainAppWrapper');
    const headerAvatar = document.getElementById('header-avatar');
    const loggedInUserNameDisplay = document.getElementById('loggedInUserName');
    const logoutButton = document.getElementById('logoutButton');

    const navTabs = document.querySelectorAll('.nav-tabs li');
    const contentSections = document.querySelectorAll('.content-section');

    const reportForm = document.getElementById('reportForm');
    const tanggalField = document.getElementById('tanggal');
    const namaField = document.getElementById('nama');
    const jamKerjaField = document.getElementById('jamKerja');
    const keteranganField = document.getElementById('keterangan');
    const fotoLaporanInput = document.getElementById('fotoLaporan');
    const imagePreview = document.getElementById('imagePreview');
    const submitReportBtn = document.getElementById('submitReportBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const reportIdToEdit = document.getElementById('reportIdToEdit');

    const riwayatLaporanContainer = document.getElementById('riwayat-laporan-container');
    const dashboardTotalReports = document.getElementById('dashboard-total-reports');
    const dashboardTotalHours = document.getElementById('dashboard-total-hours');
    const dashboardLastReport = document.getElementById('dashboard-last-report');
    const recentActivityContainer = document.getElementById('recent-activity-container');
    const notificationsContainer = document.getElementById('notifications-container');

    const historyStartDate = document.getElementById('historyStartDate');
    const historyEndDate = document.getElementById('historyEndDate');
    const searchKeyword = document.getElementById('searchKeyword');
    const filterJamKerjaMin = document.getElementById('filterJamKerjaMin');
    const filterJamKerjaMax = document.getElementById('filterJamKerjaMax');
    const sortBy = document.getElementById('sortBy');
    const sortOrder = document.getElementById('sortOrder');
    const applyHistoryFiltersBtn = document.getElementById('applyHistoryFilters');
    const clearHistoryFiltersBtn = document.getElementById('clearHistoryFilters');
    const exportReportsCSVBtn = document.getElementById('exportReportsCSV');
    const deleteAllUserReportsBtn = document.getElementById('deleteAllUserReportsBtn');

    const printStartDate = document.getElementById('printStartDate');
    const printEndDate = document.getElementById('printEndDate');
    const generatePrintBtn = document.getElementById('generatePrint');
    const downloadPdfButton = document.getElementById('downloadPdfButton');
    const pdfPreviewContainer = document.getElementById('pdf-preview-container');

    const backupUserDataBtn = document.getElementById('backupUserDataBtn');
    const restoreInput = document.getElementById('restoreInput');
    const restoreUserDataBtn = document.getElementById('restoreUserDataBtn');
    const deleteAllReportsGlobalBtn = document.getElementById('deleteAllReportsGlobalBtn');

    const toastNotification = document.getElementById('toast-notification');

    // --- Validation Map ---
    const validationErrors = {
        tanggal: 'Tanggal laporan wajib diisi.',
        nama: 'Nama pengurus wajib dipilih.',
        jamKerja: 'Jam kerja wajib diisi dan harus angka positif.',
        keterangan: 'Keterangan kegiatan wajib diisi.'
    };

    // --- Functions ---

    // Login and Logout Functions
    function showLoginScreen() {
        loginContainer.style.display = 'block';
        mainAppWrapper.style.display = 'none';
        loggedInUser = null;
        localStorage.removeItem('loggedInUser');
        loginPasswordInput.value = ''; // Clear password on logout
        loginUsernameSelect.value = ''; // Clear username selection on logout
        loginError.style.display = 'none'; // Hide error message
        namaField.value = ''; // Clear report form name field
        headerAvatar.textContent = '-'; // Clear avatar
        loggedInUserNameDisplay.textContent = ''; // Clear user name
        clearReportFormValidation(); // Clear any validation errors from previous session
    }

    function showMainApp(username) {
        loggedInUser = username;
        localStorage.setItem('loggedInUser', username);
        loginContainer.style.display = 'none';
        mainAppWrapper.style.display = 'block';
        namaField.value = loggedInUser; // Pre-fill name in report form
        headerAvatar.textContent = loggedInUser.charAt(0).toUpperCase(); // Set avatar initial
        loggedInUserNameDisplay.textContent = loggedInUser; // Display full username

        // Initialize dashboard and reports for the logged-in user
        updateDashboard();
        displayRiwayatLaporan();
        renderMonthlyReportsChart();
        displayNotifications();
        activateTab('dashboard'); // Automatically go to dashboard
    }

    function handleLogin() {
        const username = loginUsernameSelect.value;
        const password = loginPasswordInput.value;
        loginError.style.display = 'none'; // Hide previous error

        if (!username) {
            showToast('Pilih nama pengurus.', 'warning');
            loginError.textContent = 'Pilih nama pengurus.';
            loginError.style.display = 'block';
            return;
        }

        if (!password) {
            showToast('Masukkan password.', 'warning');
            loginError.textContent = 'Masukkan password.';
            loginError.style.display = 'block';
            return;
        }

        if (users[username] && users[username] === password) {
            showMainApp(username);
            showToast(`Selamat datang, ${username}!`, 'success');
        } else {
            showToast('Nama pengurus atau password salah!', 'danger');
            loginError.textContent = 'Nama pengurus atau password salah!';
            loginError.style.display = 'block';
        }
    }

    function handleLogout() {
        if (confirm('Apakah Anda yakin ingin logout?')) {
            showLoginScreen();
            showToast('Anda telah logout.', 'info');
        }
    }

    // --- Utility Functions ---
    function generateUniqueId() {
        return 'report_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function saveLaporanRiwayat() {
        localStorage.setItem('laporanRiwayat', JSON.stringify(laporanRiwayat));
    }

    function showToast(message, type = 'info') {
        toastNotification.textContent = message;
        toastNotification.className = 'toast-notification show'; // Reset and add show class
        toastNotification.style.backgroundColor = ''; // Clear previous background
        if (type === 'success') {
            toastNotification.style.backgroundColor = 'var(--secondary)';
        } else if (type === 'danger') {
            toastNotification.style.backgroundColor = 'var(--danger)';
        } else if (type === 'warning') {
            toastNotification.style.backgroundColor = 'var(--warning)';
        } else if (type === 'info') {
            toastNotification.style.backgroundColor = 'var(--primary)';
        }

        setTimeout(() => {
            toastNotification.classList.remove('show');
        }, 3000); // Hide after 3 seconds
    }

    function validateField(fieldElement, errorId) {
        const errorElement = document.getElementById(errorId);
        if (!fieldElement.value.trim()) {
            fieldElement.classList.add('error');
            errorElement.textContent = validationErrors[fieldElement.id];
            errorElement.style.display = 'block';
            return false;
        } else if (fieldElement.id === 'jamKerja' && (parseFloat(fieldElement.value) <= 0 || parseFloat(fieldElement.value) > 24)) {
            fieldElement.classList.add('error');
            errorElement.textContent = 'Jam kerja harus antara 1 sampai 24 jam.';
            errorElement.style.display = 'block';
            return false;
        }
        fieldElement.classList.remove('error');
        errorElement.textContent = '';
        errorElement.style.display = 'none';
        return true;
    }

    function validateForm() {
        let isValid = true;
        isValid = validateField(tanggalField, 'tanggal-error') && isValid;
        // namaField is disabled and set by login, so no user input validation needed
        isValid = validateField(jamKerjaField, 'jamKerja-error') && isValid;
        isValid = validateField(keteranganField, 'keterangan-error') && isValid;
        return isValid;
    }

    function clearReportFormValidation() {
        const fields = [tanggalField, namaField, jamKerjaField, keteranganField, fotoLaporanInput];
        fields.forEach(field => {
            field.classList.remove('error');
            const errorElement = document.getElementById(`${field.id}-error`);
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
        });
    }

    function clearForm() {
        tanggalField.value = '';
        namaField.value = loggedInUser || ''; // Keep pre-filled if logged in
        jamKerjaField.value = '';
        keteranganField.value = '';
        fotoLaporanInput.value = ''; // Clear the file input
        imagePreview.src = '#';
        imagePreview.style.display = 'none';
        submitReportBtn.textContent = 'Kirim Laporan';
        submitReportBtn.classList.remove('btn-success');
        submitReportBtn.classList.add('btn-primary');
        cancelEditBtn.style.display = 'none';
        editingReportId = null;
        reportIdToEdit.value = '';
        clearReportFormValidation();
    }

    function addNotification(message) {
        const timestamp = new Date().toLocaleString('id-ID', {
            dateStyle: 'short',
            timeStyle: 'short'
        });
        const notification = {
            id: generateUniqueId(),
            message: message,
            timestamp: timestamp,
            read: false
        };
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        notifications.unshift(notification); // Add to the beginning
        localStorage.setItem('notifications', JSON.stringify(notifications));
        displayNotifications();
    }

    function displayNotifications() {
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        notificationsContainer.innerHTML = ''; // Clear existing notifications

        if (notifications.length === 0) {
            notificationsContainer.innerHTML = `
                <div class="empty-state-small">
                    <i class="fas fa-bell-slash"></i>
                    <p>Belum ada aktivitas</p>
                </div>
            `;
            return;
        }

        notifications.forEach(notif => {
            const notifEl = document.createElement('div');
            notifEl.classList.add('notification-item');
            if (!notif.read) {
                notifEl.style.fontWeight = 'bold'; // Highlight unread
            }
            notifEl.innerHTML = `
                <p>${notif.message}</p>
                <small style="color: var(--gray);">${notif.timestamp}</small>
            `;
            // Mark as read on click
            notifEl.addEventListener('click', () => {
                notif.read = true;
                localStorage.setItem('notifications', JSON.stringify(notifications));
                displayNotifications(); // Re-render to update read status
            });
            notificationsContainer.appendChild(notifEl);
        });
    }


    // --- Report Management (CRUD) ---
    function saveReport(tanggal, nama, jamKerja, keterangan, fotoBase64) {
        // Ensure the user's report array exists
        if (!laporanRiwayat[nama]) {
            laporanRiwayat[nama] = [];
        }

        const timestamp = new Date().toISOString(); // For sorting and tracking creation time

        if (editingReportId) {
            // Edit existing report
            let reports = laporanRiwayat[nama];
            const reportIndex = reports.findIndex(report => report.id === editingReportId);
            if (reportIndex !== -1) {
                reports[reportIndex] = {
                    ...reports[reportIndex], // Keep original timestamp and id
                    tanggal,
                    nama,
                    jamKerja: parseFloat(jamKerja),
                    keterangan,
                    fotoBase64,
                    updatedAt: timestamp // Add an update timestamp
                };
                showToast('Laporan berhasil diperbarui!', 'success');
                addNotification(`Laporan tanggal ${tanggal} diperbarui.`);
            }
            editingReportId = null;
            reportIdToEdit.value = '';
            submitReportBtn.textContent = 'Kirim Laporan';
            submitReportBtn.classList.remove('btn-success');
            submitReportBtn.classList.add('btn-primary');
            cancelEditBtn.style.display = 'none';
        } else {
            // Add new report
            const newReport = {
                id: generateUniqueId(),
                tanggal,
                nama,
                jamKerja: parseFloat(jamKerja),
                keterangan,
                fotoBase64,
                timestamp: timestamp // Store creation timestamp
            };
            laporanRiwayat[nama].unshift(newReport); // Add to the beginning of the specific user's array
            showToast('Laporan berhasil ditambahkan!', 'success');
            addNotification(`Laporan baru tanggal ${tanggal} dari ${nama} ditambahkan.`);
        }
        saveLaporanRiwayat();
        clearForm();
        updateDashboard();
        displayRiwayatLaporan();
        renderMonthlyReportsChart(); // Re-render chart after data change
    }

    function editReport(reportId) {
        if (!loggedInUser || !laporanRiwayat[loggedInUser]) {
            showToast('Anda harus login untuk mengedit laporan.', 'danger');
            return;
        }

        const report = laporanRiwayat[loggedInUser].find(r => r.id === reportId);
        if (report) {
            tanggalField.value = report.tanggal;
            namaField.value = report.nama;
            jamKerjaField.value = report.jamKerja;
            keteranganField.value = report.keterangan;
            if (report.fotoBase64) {
                imagePreview.src = report.fotoBase64;
                imagePreview.style.display = 'block';
            } else {
                imagePreview.src = '#';
                imagePreview.style.display = 'none';
            }
            editingReportId = report.id;
            reportIdToEdit.value = report.id;
            submitReportBtn.textContent = 'Perbarui Laporan';
            submitReportBtn.classList.remove('btn-primary');
            submitReportBtn.classList.add('btn-success');
            cancelEditBtn.style.display = 'inline-block';
            activateTab('lapor'); // Switch to "Buat Laporan" tab
        } else {
            showToast('Laporan tidak ditemukan.', 'danger');
        }
    }

    function deleteReport(reportId) {
        if (!loggedInUser || !laporanRiwayat[loggedInUser]) {
            showToast('Anda harus login untuk menghapus laporan.', 'danger');
            return;
        }

        if (confirm('Apakah Anda yakin ingin menghapus laporan ini?')) {
            laporanRiwayat[loggedInUser] = laporanRiwayat[loggedInUser].filter(report => report.id !== reportId);
            saveLaporanRiwayat();
            displayRiwayatLaporan();
            updateDashboard();
            renderMonthlyReportsChart(); // Re-render chart
            showToast('Laporan berhasil dihapus!', 'success');
            addNotification(`Laporan dihapus.`);
            clearForm(); // Clear form if current editing report is deleted
        }
    }

    function deleteAllUserReports() {
        if (!loggedInUser) {
            showToast('Anda harus login untuk melakukan tindakan ini.', 'danger');
            return;
        }
        if (confirm(`Apakah Anda yakin ingin menghapus SEMUA laporan untuk ${loggedInUser}? Tindakan ini tidak dapat dibatalkan!`)) {
            delete laporanRiwayat[loggedInUser];
            saveLaporanRiwayat();
            displayRiwayatLaporan(); // Clear history display
            updateDashboard(); // Reset dashboard stats
            renderMonthlyReportsChart(); // Clear chart
            showToast(`Semua laporan untuk ${loggedInUser} telah dihapus.`, 'success');
            addNotification(`Semua laporan ${loggedInUser} dihapus.`);
        }
    }

    function deleteAllReportsGlobally() {
        if (confirm('PERINGATAN: Tindakan ini akan menghapus SEMUA laporan dari SEMUA pengurus. Apakah Anda yakin ingin melanjutkan? INI TIDAK DAPAT DIBATALKAN!')) {
            if (confirm('KONFIRMASI TERAKHIR: Ini akan menghapus SEMUA DATA LAPORAN. Klik OK untuk konfirmasi.')) {
                localStorage.removeItem('laporanRiwayat');
                laporanRiwayat = {}; // Reset in memory
                showToast('Semua laporan (global) telah dihapus!', 'success');
                addNotification('Semua laporan global telah dihapus oleh seorang admin.'); // General notification
                showLoginScreen(); // Force re-login
                // Clear all displays
                displayRiwayatLaporan();
                updateDashboard();
                renderMonthlyReportsChart();
            }
        }
    }

    // --- Display and Filter Reports ---
    function displayRiwayatLaporan() {
        riwayatLaporanContainer.innerHTML = '';
        if (!loggedInUser) {
            riwayatLaporanContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-check"></i>
                    <p>Silakan login untuk melihat riwayat laporan Anda.</p>
                </div>
            `;
            return;
        }

        let reports = laporanRiwayat[loggedInUser] || [];
        let filteredReports = [...reports]; // Create a mutable copy for filtering

        // Apply filters
        const start = historyStartDate.value ? new Date(historyStartDate.value) : null;
        const end = historyEndDate.value ? new Date(historyEndDate.value) : null;
        const keyword = searchKeyword.value.toLowerCase();
        const minJamKerja = parseFloat(filterJamKerjaMin.value) || 0;
        const maxJamKerja = parseFloat(filterJamKerjaMax.value) || 24; // Default max 24 hours

        filteredReports = filteredReports.filter(report => {
            const reportDate = new Date(report.tanggal);
            const matchesDate = (!start || reportDate >= start) && (!end || reportDate <= end);
            const matchesKeyword = !keyword || report.keterangan.toLowerCase().includes(keyword);
            const matchesJamKerja = report.jamKerja >= minJamKerja && report.jamKerja <= maxJamKerja;
            return matchesDate && matchesKeyword && matchesJamKerja;
        });

        // Apply sorting
        const sortByKey = sortBy.value;
        const order = sortOrder.value;

        filteredReports.sort((a, b) => {
            let valA, valB;
            if (sortByKey === 'tanggal') {
                valA = new Date(a.tanggal).getTime();
                valB = new Date(b.tanggal).getTime();
            } else if (sortByKey === 'timestamp') {
                valA = new Date(a.timestamp).getTime();
                valB = new Date(b.timestamp).getTime();
            } else { // jamKerja
                valA = a[sortByKey];
                valB = b[sortByKey];
            }

            if (order === 'asc') {
                return valA - valB;
            } else {
                return valB - valA;
            }
        });


        if (filteredReports.length === 0) {
            riwayatLaporanContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>Tidak ada laporan yang ditemukan dengan filter yang dipilih.</p>
                </div>
            `;
            return;
        }

        filteredReports.forEach(report => {
            const reportEl = document.createElement('div');
            reportEl.classList.add('history-item');
            const formattedDate = new Date(report.tanggal).toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            const timestampFormatted = new Date(report.timestamp).toLocaleString('id-ID', {
                dateStyle: 'short',
                timeStyle: 'short'
            });

            reportEl.innerHTML = `
                <div class="report-header">
                    <div>
                        <h3 style="margin-bottom: 5px;">Laporan Tanggal: ${formattedDate}</h3>
                        <div class="report-meta">
                            <span><i class="fas fa-user-circle"></i> ${report.nama}</span>
                            <span><i class="fas fa-hourglass-start"></i> ${report.jamKerja} Jam</span>
                            <span title="Dibuat pada"><i class="fas fa-clock"></i> ${timestampFormatted}</span>
                        </div>
                    </div>
                    <div class="report-actions">
                        <span class="action-btn edit-btn" data-id="${report.id}" title="Edit"><i class="fas fa-edit"></i></span>
                        <span class="action-btn delete-btn" data-id="${report.id}" title="Hapus"><i class="fas fa-trash-alt"></i></span>
                        ${report.fotoBase64 ? `<span class="action-btn view-photo-btn" data-photo="${report.fotoBase64}" title="Lihat Foto"><i class="fas fa-image"></i></span>` : ''}
                    </div>
                </div>
                <div class="report-content">
                    <p>${report.keterangan.replace(/\n/g, '<br>')}</p>
                    ${report.fotoBase64 ? `<img src="${report.fotoBase64}" alt="Foto Laporan" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-top: 10px; display: block;">` : ''}
                </div>
            `;
            riwayatLaporanContainer.appendChild(reportEl);
        });

        // Add event listeners for edit and delete buttons
        riwayatLaporanContainer.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => editReport(e.currentTarget.dataset.id));
        });

        riwayatLaporanContainer.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => deleteReport(e.currentTarget.dataset.id));
        });

        riwayatLaporanContainer.querySelectorAll('.view-photo-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const photoData = e.currentTarget.dataset.photo;
                const newWindow = window.open();
                newWindow.document.body.innerHTML = `<img src="${photoData}" style="max-width: 100%; height: auto;">`;
                newWindow.document.title = 'Foto Laporan';
            });
        });
    }


    function updateDashboard() {
        if (!loggedInUser) {
            dashboardTotalReports.textContent = '0';
            dashboardTotalHours.textContent = '0';
            dashboardLastReport.textContent = 'Belum ada';
            recentActivityContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard"></i>
                    <p>Silakan login untuk melihat ringkasan laporan Anda.</p>
                </div>
            `;
            return;
        }

        const userReports = laporanRiwayat[loggedInUser] || [];
        const totalReports = userReports.length;
        const totalHours = userReports.reduce((sum, report) => sum + report.jamKerja, 0);

        dashboardTotalReports.textContent = totalReports;
        dashboardTotalHours.textContent = totalHours;

        if (totalReports > 0) {
            // Sort by timestamp (most recent first) to get the last report
            const sortedReports = [...userReports].sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
            const lastReportDate = new Date(sortedReports[0].tanggal).toLocaleDateString('id-ID', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
            dashboardLastReport.textContent = lastReportDate;

            // Display recent activities
            recentActivityContainer.innerHTML = '';
            const recentCount = Math.min(sortedReports.length, 5); // Show up to 5 recent reports
            for (let i = 0; i < recentCount; i++) {
                const report = sortedReports[i];
                const activityEl = document.createElement('div');
                activityEl.classList.add('history-item'); // Reuse history-item style for consistency
                activityEl.style.padding = '10px';
                activityEl.style.marginBottom = '10px';
                activityEl.innerHTML = `
                    <p><strong>${new Date(report.tanggal).toLocaleDateString('id-ID')}</strong> - ${report.keterangan.substring(0, 100)}${report.keterangan.length > 100 ? '...' : ''} (${report.jamKerja} Jam)</p>
                    <div style="text-align: right; font-size: 0.8em; color: var(--gray);">${new Date(report.timestamp).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}</div>
                `;
                recentActivityContainer.appendChild(activityEl);
            }
        } else {
            dashboardLastReport.textContent = 'Belum ada';
            recentActivityContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard"></i>
                    <p>Belum ada laporan dari Anda.</p>
                </div>
            `;
        }
    }

    // --- Charting ---
    function renderMonthlyReportsChart() {
        if (!loggedInUser) {
            if (monthlyReportsChartInstance) {
                monthlyReportsChartInstance.destroy();
                monthlyReportsChartInstance = null;
            }
            const chartContainer = document.getElementById('monthlyReportsChart').parentElement;
            chartContainer.innerHTML = `
                <div class="empty-state-small">
                    <i class="fas fa-chart-line"></i>
                    <p>Login untuk melihat statistik laporan bulanan Anda.</p>
                </div>
            `;
            return;
        }

        const userReports = laporanRiwayat[loggedInUser] || [];
        const monthlyData = {}; // Stores { 'YYYY-MM': { reports: count, hours: totalHours } }

        userReports.forEach(report => {
            const date = new Date(report.tanggal);
            const yearMonth = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
            if (!monthlyData[yearMonth]) {
                monthlyData[yearMonth] = {
                    reports: 0,
                    hours: 0
                };
            }
            monthlyData[yearMonth].reports++;
            monthlyData[yearMonth].hours += report.jamKerja;
        });

        const sortedMonths = Object.keys(monthlyData).sort();
        const labels = sortedMonths.map(ym => {
            const [year, month] = ym.split('-');
            const date = new Date(year, month - 1, 1);
            return date.toLocaleDateString('id-ID', {
                month: 'short',
                year: '2-digit'
            });
        });
        const reportCounts = sortedMonths.map(ym => monthlyData[ym].reports);
        const hoursCounts = sortedMonths.map(ym => monthlyData[ym].hours);

        const ctx = document.getElementById('monthlyReportsChart').getContext('2d');

        // Destroy old chart if it exists
        if (monthlyReportsChartInstance) {
            monthlyReportsChartInstance.destroy();
        }

        monthlyReportsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jumlah Laporan',
                    data: reportCounts,
                    backgroundColor: 'rgba(52, 152, 219, 0.7)', // Primary color
                    borderColor: 'rgba(52, 152, 219, 1)',
                    borderWidth: 1,
                    yAxisID: 'y-reports'
                }, {
                    label: 'Total Jam Kerja',
                    data: hoursCounts,
                    backgroundColor: 'rgba(46, 204, 113, 0.7)', // Secondary color
                    borderColor: 'rgba(46, 204, 113, 1)',
                    borderWidth: 1,
                    yAxisID: 'y-hours'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    },
                    title: {
                        display: true,
                        text: 'Statistik Laporan & Jam Kerja per Bulan'
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Bulan'
                        }
                    },
                    'y-reports': {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Jumlah Laporan'
                        },
                        grid: {
                            drawOnChartArea: false, // Only draw grid lines for one y-axis
                        }
                    },
                    'y-hours': {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Total Jam Kerja (Jam)'
                        },
                        grid: {
                            drawOnChartArea: false, // Only draw grid lines for one y-axis
                        }
                    }
                }
            }
        });
    }

    // --- PDF Generation ---
    function generatePdfPreview() {
        pdfPreviewContainer.innerHTML = '';
        downloadPdfButton.style.display = 'none';

        if (!loggedInUser) {
            pdfPreviewContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-check"></i>
                    <p>Silakan login untuk menampilkan laporan.</p>
                </div>
            `;
            return;
        }

        const userReports = laporanRiwayat[loggedInUser] || [];
        let reportsToPrint = [...userReports];

        const startDate = printStartDate.value ? new Date(printStartDate.value) : null;
        const endDate = printEndDate.value ? new Date(printEndDate.value) : null;

        reportsToPrint = reportsToPrint.filter(report => {
            const reportDate = new Date(report.tanggal);
            const matchesStartDate = !startDate || reportDate >= startDate;
            const matchesEndDate = !endDate || reportDate <= endDate;
            return matchesStartDate && matchesEndDate;
        });

        if (reportsToPrint.length === 0) {
            pdfPreviewContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-info-circle"></i>
                    <p>Tidak ada laporan yang ditemukan untuk rentang tanggal yang dipilih.</p>
                </div>
            `;
            return;
        }

        // Sort reports by date (oldest first for PDF display)
        reportsToPrint.sort((a, b) => new Date(a.tanggal).getTime() - new Date(b.tanggal).getTime());

        const previewContent = document.createElement('div');
        previewContent.id = 'pdfContent'; // ID for html2canvas
        previewContent.innerHTML = `<h3>Laporan Harian ${loggedInUser}<br>Periode: ${printStartDate.value || 'Awal'} s/d ${printEndDate.value || 'Akhir'}</h3>`;

        reportsToPrint.forEach(report => {
            const reportItem = document.createElement('div');
            reportItem.classList.add('pdf-report-item');
            const formattedDate = new Date(report.tanggal).toLocaleDateString('id-ID', {
                weekday: 'long',
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });

            reportItem.innerHTML = `
                <p><strong>Tanggal:</strong> ${formattedDate}</p>
                <p><strong>Nama Pengurus:</strong> ${report.nama}</p>
                <p><strong>Jam Kerja:</strong> ${report.jamKerja} Jam</p>
                <p><strong>Keterangan:</strong></p>
                <p style="margin-left: 15px; white-space: pre-wrap;">${report.keterangan}</p>
                ${report.fotoBase64 ? `<img src="${report.fotoBase64}" alt="Foto Laporan" style="max-width: 100%; height: auto; display: block; margin-top: 10px;">` : ''}
                <br>
            `;
            previewContent.appendChild(reportItem);
        });
        pdfPreviewContainer.appendChild(previewContent);
        downloadPdfButton.style.display = 'inline-block';
    }


    async function downloadPdfReport() {
        const {
            jsPDF
        } = window.jspdf;
        const input = document.getElementById('pdfContent'); // Element to convert

        if (!input) {
            showToast('Tidak ada konten untuk diunduh. Silakan tampilkan laporan terlebih dahulu.', 'danger');
            return;
        }

        showToast('Membuat PDF, mohon tunggu...', 'info');

        try {
            const canvas = await html2canvas(input, {
                scale: 2, // Increase scale for better quality
                useCORS: true // Important for images from base64 if hosted externally
            });

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); // Portrait, millimeters, A4 size
            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            const fileName = `Laporan_Harian_${loggedInUser}_${printStartDate.value}_sd_${printEndDate.value}.pdf`;
            pdf.save(fileName);
            showToast('PDF berhasil diunduh!', 'success');
            addNotification(`Laporan PDF periode ${printStartDate.value} s/d ${printEndDate.value} diunduh.`);
        } catch (error) {
            console.error('Error generating PDF:', error);
            showToast('Gagal membuat PDF. Coba lagi.', 'danger');
        }
    }


    // --- Backup & Restore ---
    function backupUserData() {
        if (!loggedInUser) {
            showToast('Silakan login untuk mengunduh backup data Anda.', 'danger');
            return;
        }

        const userData = laporanRiwayat[loggedInUser] || [];
        const dataStr = JSON.stringify(userData, null, 2); // Pretty print JSON

        const blob = new Blob([dataStr], {
            type: 'application/json'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const fileName = `backup_laporan_${loggedInUser}_${new Date().toISOString().slice(0,10)}.json`;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Backup data berhasil diunduh!', 'success');
        addNotification(`Backup data untuk ${loggedInUser} diunduh.`);
    }

    function restoreUserData(event) {
        if (!loggedInUser) {
            showToast('Silakan login untuk memulihkan data Anda.', 'danger');
            return;
        }

        const file = event.target.files[0];
        if (!file) {
            showToast('Pilih file JSON untuk diunggah.', 'warning');
            return;
        }

        if (file.type !== 'application/json') {
            showToast('File yang diunggah harus berformat JSON.', 'danger');
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const restoredData = JSON.parse(e.target.result);
                if (!Array.isArray(restoredData)) {
                    showToast('Format file JSON tidak valid. Seharusnya array laporan.', 'danger');
                    return;
                }

                // Append or overwrite strategy. Here, we'll overwrite for the current user.
                if (confirm(`Ini akan mengganti semua laporan Anda saat ini (${loggedInUser}) dengan data dari file. Lanjutkan?`)) {
                    laporanRiwayat[loggedInUser] = restoredData;
                    saveLaporanRiwayat();
                    showToast('Data laporan berhasil dipulihkan!', 'success');
                    addNotification(`Data laporan untuk ${loggedInUser} dipulihkan dari backup.`);
                    updateDashboard();
                    displayRiwayatLaporan();
                    renderMonthlyReportsChart();
                    activateTab('riwayat'); // Go to history after restore
                }
            } catch (error) {
                console.error('Error parsing JSON:', error);
                showToast('Gagal memproses file JSON. Pastikan formatnya benar.', 'danger');
            }
        };
        reader.readAsText(file);
    }

    // --- CSV Export ---
    function exportReportsToCSV() {
        if (!loggedInUser) {
            showToast('Silakan login untuk mengexport data.', 'danger');
            return;
        }

        const userReports = laporanRiwayat[loggedInUser] || [];
        let filteredReports = [...userReports]; // Copy to apply current filters

        // Apply filters (same logic as displayRiwayatLaporan)
        const start = historyStartDate.value ? new Date(historyStartDate.value) : null;
        const end = historyEndDate.value ? new Date(historyEndDate.value) : null;
        const keyword = searchKeyword.value.toLowerCase();
        const minJamKerja = parseFloat(filterJamKerjaMin.value) || 0;
        const maxJamKerja = parseFloat(filterJamKerjaMax.value) || 24;

        filteredReports = filteredReports.filter(report => {
            const reportDate = new Date(report.tanggal);
            const matchesDate = (!start || reportDate >= start) && (!end || reportDate <= end);
            const matchesKeyword = !keyword || report.keterangan.toLowerCase().includes(keyword);
            const matchesJamKerja = report.jamKerja >= minJamKerja && report.jamKerja <= maxJamKerja;
            return matchesDate && matchesKeyword && matchesJamKerja;
        });

        if (filteredReports.length === 0) {
            showToast('Tidak ada laporan untuk di-export dengan filter saat ini.', 'warning');
            return;
        }

        // Prepare data for CSV
        const csvData = filteredReports.map(report => ({
            "ID Laporan": report.id,
            "Tanggal Laporan": report.tanggal,
            "Nama Pengurus": report.nama,
            "Jam Kerja": report.jamKerja,
            "Keterangan": report.keterangan.replace(/"/g, '""'), // Handle double quotes in text
            "URL Foto (Base64)": report.fotoBase64 || '', // Include photo data as URL/Base64
            "Waktu Dibuat": new Date(report.timestamp).toLocaleString('id-ID'),
            "Waktu Diperbarui": report.updatedAt ? new Date(report.updatedAt).toLocaleString('id-ID') : ''
        }));

        // Convert array of objects to CSV string
        const csv = PapaParse.unparse(csvData);

        const blob = new Blob([csv], {
            type: 'text/csv;charset=utf-8;'
        });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `laporan_${loggedInUser}_${new Date().toISOString().slice(0,10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Laporan berhasil di-export ke CSV!', 'success');
        addNotification(`Laporan CSV untuk ${loggedInUser} diunduh.`);
    }


    // --- Event Listeners ---
    loginButton.addEventListener('click', handleLogin);
    logoutButton.addEventListener('click', handleLogout);

    navTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const target = document.querySelector(tab.dataset.tabTarget);
            contentSections.forEach(section => section.classList.remove('active'));
            navTabs.forEach(t => t.classList.remove('active'));
            target.classList.add('active');
            tab.classList.add('active');

            // Specific actions on tab change
            if (tab.dataset.tabTarget === '#riwayat') {
                displayRiwayatLaporan();
            } else if (tab.dataset.tabTarget === '#dashboard') {
                updateDashboard();
                renderMonthlyReportsChart();
            } else if (tab.dataset.tabTarget === '#lapor') {
                if (!editingReportId) { // Only clear form if not in editing mode
                    clearForm();
                }
                namaField.value = loggedInUser; // Ensure nama field is pre-filled
            }
        });
    });

    reportForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!validateForm()) {
            showToast('Mohon lengkapi semua kolom yang wajib diisi.', 'danger');
            return;
        }

        const tanggal = tanggalField.value;
        const nama = namaField.value;
        const jamKerja = jamKerjaField.value;
        const keterangan = keteranganField.value;
        const fotoBase64 = imagePreview.src === '#' || imagePreview.style.display === 'none' ? null : imagePreview.src;

        saveReport(tanggal, nama, jamKerja, keterangan, fotoBase64);
    });

    cancelEditBtn.addEventListener('click', () => {
        clearForm();
        showToast('Edit laporan dibatalkan.', 'info');
    });

    fotoLaporanInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.src = '#';
            imagePreview.style.display = 'none';
        }
    });

    // Filtering and Export Events
    applyHistoryFiltersBtn.addEventListener('click', displayRiwayatLaporan);
    clearHistoryFiltersBtn.addEventListener('click', () => {
        historyStartDate.value = today;
        historyEndDate.value = today;
        searchKeyword.value = '';
        filterJamKerjaMin.value = '';
        filterJamKerjaMax.value = '';
        sortBy.value = 'timestamp';
        sortOrder.value = 'desc';
        displayRiwayatLaporan();
        showToast('Filter riwayat laporan direset.', 'info');
    });
    exportReportsCSVBtn.addEventListener('click', exportReportsToCSV);
    deleteAllUserReportsBtn.addEventListener('click', deleteAllUserReports);


    // PDF Events
    generatePrintBtn.addEventListener('click', generatePdfPreview);
    downloadPdfButton.addEventListener('click', downloadPdfReport);


    // Data Management Events
    backupUserDataBtn.addEventListener('click', backupUserData);
    restoreInput.addEventListener('change', (event) => restoreUserData(event));
    restoreUserDataBtn.addEventListener('click', () => {
        // Trigger the file input click programmatically
        restoreInput.click();
    });
    deleteAllReportsGlobalBtn.addEventListener('click', deleteAllReportsGlobally);


    function activateTab(tabId) {
        // Find the tab element and simulate click
        const targetTab = document.querySelector(`.nav-tabs li[data-tab-target=\"#${tabId}\"]`);
        if (targetTab) {
            targetTab.click();
        }
    }

    // Set default date for print/history filters
    const today = new Date().toISOString().split('T')[0];
    printStartDate.value = today;
    printEndDate.value = today;
    historyStartDate.value = today;
    historyEndDate.value = today;

    // Check login state on page load
    window.onload = () => {
        if (loggedInUser) {
            showMainApp(loggedInUser);
        } else {
            showLoginScreen();
        }
    };

    // Removed the populate login select with predefined users loop
    // as the options are now directly in the HTML.
  </script>
</body>
</html>
